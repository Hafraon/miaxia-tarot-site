#!/bin/bash

echo "üöÄ MiaxiaLip Deploy Script"
echo "=========================="

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js –≤–µ—Ä—Å—ñ—ó
echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä—è—é Node.js..."
node --version
npm --version

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à—ñ–≤
echo "üßπ –û—á–∏—â—É—é –∫–µ—à—ñ..."
rm -rf node_modules/.cache
rm -rf dist

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª—é—é –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ..."
npm ci --production=false

# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç–µ–π (–Ω–µ breaking changes)
echo "üîß –í–∏–ø—Ä–∞–≤–ª—è—é –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ..."
npm audit fix --only=prod || echo "‚ö†Ô∏è –î–µ—è–∫—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ"

# –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É
echo "üî® –ó–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
npm run build

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –∑–±—ñ—Ä–∫–∏
if [ -d "dist" ]; then
    echo "‚úÖ –ó–±—ñ—Ä–∫–∞ —É—Å–ø—ñ—à–Ω–∞!"
    echo "üìÅ –§–∞–π–ª–∏ –≤ dist:"
    ls -la dist/
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±—ñ—Ä–∫–∏!"
    exit 1
fi

echo "üéâ –î–µ–ø–ª–æ–π –≥–æ—Ç–æ–≤–∏–π!"
